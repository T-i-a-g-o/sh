<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meus Favoritos Shopee</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-800">List</h1>
            
        </header>

        <div class="mb-4">
            <button id="btn-atualizar" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold">
                Atualizar Preços do Carrinho
            </button>
        </div>

        <div class="bg-white shadow-md rounded-lg overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Produto</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Preço Atual</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Último</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Menor</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Maior</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ações</th>
                    </tr>
                </thead>
                <tbody id="lista-produtos" class="bg-white divide-y divide-gray-200">
                    <tr><td colspan="6" class="text-center py-8 text-gray-500">Clique em "Atualizar Preços" para começar.</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const CHAVE_PRODUTOS = "shopee_favoritos";
        const CHAVE_ATUALIZACAO = "shopee_update_request";
        const CHAVE_DADOS = "shopee_cart_data";

        function getProdutos() {
            const data = localStorage.getItem(CHAVE_PRODUTOS);
            return data ? JSON.parse(data) : [];
        }

        function salvarProdutos(lista) {
            localStorage.setItem(CHAVE_PRODUTOS, JSON.stringify(lista));
        }

        function renderizar() {
            const lista = getProdutos();
            const tbody = document.getElementById('lista-produtos');
            tbody.innerHTML = '';

            if (lista.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-gray-500">Nenhum produto salvo ainda.</td></tr>`;
                return;
            }

            lista.forEach(p => {
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="px-6 py-3"><a href="${p.url}" target="_blank" class="text-blue-600 hover:underline">${p.nome}</a></td>
                    <td class="px-6 py-3 font-bold">${formatarPreco(p.precoAtual)}</td>
                    <td class="px-6 py-3">${p.ultimoPreco ? formatarPreco(p.ultimoPreco) : '-'}</td>
                    <td class="px-6 py-3 text-green-600">${formatarPreco(p.menorPreco)}</td>
                    <td class="px-6 py-3 text-red-600">${formatarPreco(p.maiorPreco)}</td>
                    <td class="px-6 py-3"><button class="text-red-600 text-sm btn-excluir" data-id="${p.id}">Excluir</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function formatarPreco(v) {
            return `R$ ${v.toFixed(2).replace('.', ',')}`;
        }

        function excluir(e) {
            if (!e.target.classList.contains('btn-excluir')) return;
            const id = e.target.dataset.id;
            let lista = getProdutos();
            lista = lista.filter(p => p.id != id);
            salvarProdutos(lista);
            renderizar();
        }

        function processarDados(freshList) {
            let lista = getProdutos();
            const urlsNoCarrinho = new Set(freshList.map(p => p.url));
            let novos = 0, atualizados = 0;

            freshList.forEach(fresh => {
                const existente = lista.find(p => p.url === fresh.url);
                if (existente) {
                    if (existente.precoAtual !== fresh.price) {
                        existente.ultimoPreco = existente.precoAtual;
                        existente.precoAtual = fresh.price;
                        if (fresh.price < existente.menorPreco) existente.menorPreco = fresh.price;
                        if (fresh.price > existente.maiorPreco) existente.maiorPreco = fresh.price;
                        atualizados++;
                    }
                    existente.nome = fresh.name;
                } else {
                    lista.push({
                        id: Date.now() + Math.random(),
                        nome: fresh.name,
                        url: fresh.url,
                        precoAtual: fresh.price,
                        ultimoPreco: fresh.price,
                        menorPreco: fresh.price,
                        maiorPreco: fresh.price
                    });
                    novos++;
                }
            });

            lista = lista.filter(p => urlsNoCarrinho.has(p.url));
            salvarProdutos(lista);
            renderizar();

            if (novos > 0 || atualizados > 0) {
                const h1 = document.querySelector('h1');
                const orig = h1.textContent;
                h1.textContent = `Atualizado! (+${novos}, ${atualizados})`;
                h1.style.color = '#28a745';
                setTimeout(() => { h1.textContent = orig; h1.style.color = ''; }, 2000);
            }

            // Limpa dados temporários
            localStorage.removeItem(CHAVE_DADOS);
            localStorage.removeItem(CHAVE_ATUALIZACAO);
        }

        // ESCUTA ATUALIZAÇÃO
        function verificarAtualizacao() {
            const dados = localStorage.getItem(CHAVE_DADOS);
            if (dados) {
                try {
                    const parsed = JSON.parse(dados);
                    processarDados(parsed);
                } catch (e) {
                    console.error("Erro ao processar dados:", e);
                }
            }
        }

        // Polling a cada 1s
        setInterval(verificarAtualizacao, 1000);

        // BOTÃO ATUALIZAR
        document.getElementById('btn-atualizar').addEventListener('click', () => {
            const sessionId = Date.now();
            localStorage.setItem(CHAVE_ATUALIZACAO, sessionId);
            const url = `https://shopee.com.br/cart`;
            const win = window.open(url, '_blank');
            if (!win) {
                alert("Popup bloqueado! Permita popups para shopee.com.br");
            } else {
                setTimeout(() => {
                    localStorage.removeItem(CHAVE_ATUALIZACAO);
                }, 30000); // Expira em 30s
            }
        });

        // Inicialização
        window.addEventListener('load', () => {
            document.getElementById('lista-produtos').addEventListener('click', excluir);
            renderizar();
            verificarAtualizacao();
        });
    </script>
</body>
</html>
