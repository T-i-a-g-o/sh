<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meus Favoritos Shopee</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .product-toggle { cursor: pointer; user-select: none; }
609        .product-toggle::before { content: 'Right Arrow '; font-size: 0.8em; }
        .product-toggle.expanded::before { content: 'Down Arrow '; }
        .sub-row { display: none; }
        .product-toggle.expanded + .sub-row { display: table-row; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Meus Favoritos Shopee</h1>
            <p class="text-sm text-gray-600 mt-1">Atualiza automaticamente ao salvar o carrinho na Shopee</p>
        </header>

        <div class="bg-white shadow-md rounded-lg overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Produto</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Preço Atual</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Último</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Menor</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Maior</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ações</th>
                    </tr>
                </thead>
                <tbody id="lista-produtos" class="bg-white divide-y divide-gray-200">
                    <tr><td colspan="6" class="text-center py-8 text-gray-500">Carregando...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- MANAGER EMBUTIDO NO HTML -->
    <script>
        const CHAVE_CARRINHO = "shopee_cart_snapshot";
        const CHAVE_PRODUTOS = "shopee_favoritos";

        function getProdutos() {
            const data = localStorage.getItem(CHAVE_PRODUTOS);
            return data ? JSON.parse(data) : [];
        }

        function salvarProdutos(lista) {
            localStorage.setItem(CHAVE_PRODUTOS, JSON.stringify(lista));
        }

        function formatarPreco(v) {
            return `R$ ${v.toFixed(2).replace('.', ',')}`;
        }

        function renderizar() {
            const lista = getProdutos();
            const tbody = document.getElementById('lista-produtos');
            tbody.innerHTML = '';

            if (lista.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-gray-500">Nenhum produto salvo ainda.<br><small>Adicione itens no carrinho da Shopee e volte aqui.</small></td></tr>`;
                return;
            }

            lista.forEach(p => {
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="px-6 py-3"><a href="${p.url}" target="_blank" class="text-blue-600 hover:underline">${p.nome}</a></td>
                    <td class="px-6 py-3 font-bold">${formatarPreco(p.precoAtual)}</td>
                    <td class="px-6 py-3">${p.ultimoPreco ? formatarPreco(p.ultimoPreco) : '-'}</td>
                    <td class="px-6 py-3 text-green-600">${formatarPreco(p.menorPreco)}</td>
                    <td class="px-6 py-3 text-red-600">${formatarPreco(p.maiorPreco)}</td>
                    <td class="px-6 py-3"><button class="text-red-600 text-sm btn-excluir" data-id="${p.id}">Excluir</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function excluir(e) {
            if (!e.target.classList.contains('btn-excluir')) return;
            const id = e.target.dataset.id;
            let lista = getProdutos();
            lista = lista.filter(p => p.id != id);
            salvarProdutos(lista);
            renderizar();
        }

        function processarSnapshot() {
            const data = localStorage.getItem(CHAVE_CARRINHO);
            if (!data) return;

            let snapshot;
            try {
                snapshot = JSON.parse(data);
            } catch (e) {
                console.error("Erro ao ler snapshot:", e);
                return;
            }

            if (!Array.isArray(snapshot) || snapshot.length === 0) return;

            let lista = getProdutos();
            const urlsNoCarrinho = new Set(snapshot.map(p => p.url));
            let novos = 0, atualizados = 0;

            snapshot.forEach(fresh => {
                const existente = lista.find(p => p.url === fresh.url);
                if (existente) {
                    if (existente.precoAtual !== fresh.price) {
                        existente.ultimoPreco = existente.precoAtual;
                        existente.precoAtual = fresh.price;
                        if (fresh.price < existente.menorPreco) existente.menorPreco = fresh.price;
                        if (fresh.price > existente.maiorPreco) existente.maiorPreco = fresh.price;
                        atualizados++;
                    }
                    existente.nome = fresh.name;
                } else {
                    lista.push({
                        id: Date.now() + Math.random(),
                        nome: fresh.name,
                        url: fresh.url,
                        precoAtual: fresh.price,
                        ultimoPreco: fresh.price,
                        menorPreco: fresh.price,
                        maiorPreco: fresh.price
                    });
                    novos++;
                }
            });

            lista = lista.filter(p => urlsNoCarrinho.has(p.url));
            salvarProdutos(lista);
            renderizar();

            // Feedback visual
            const h1 = document.querySelector('h1');
            if (h1 && (novos > 0 || atualizados > 0)) {
                const orig = h1.textContent;
                h1.textContent = `Atualizado! (+${novos}, ${atualizados})`;
                h1.style.color = '#28a745';
                setTimeout(() => { h1.textContent = orig; h1.style.color = ''; }, 2000);
            }

            // Limpa snapshot
            localStorage.removeItem(CHAVE_CARRINHO);
        }

        // Escuta mudanças no localStorage (mesmo em outras abas)
        window.addEventListener('storage', (e) => {
            if (e.key === CHAVE_CARRINHO) {
                console.log("Snapshot recebido via storage event!");
                processarSnapshot();
            }
        });

        // Ao carregar a página
        window.addEventListener('load', () => {
            document.getElementById('lista-produtos').addEventListener('click', excluir);
            renderizar();
            processarSnapshot(); // Processa se já tiver dados
            console.log("Manager carregado. Escutando localStorage...");
        });
    </script>
</body>
</html>
